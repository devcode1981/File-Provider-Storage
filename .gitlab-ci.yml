services:
- docker:dind

stages:
- shellcheck
- rubocop
- build
- test

variables:
  DOCKER_DRIVER: overlay
  TEST_IMAGE: registry.gitlab.com/$CI_PROJECT_NAMESPACE/gitlab-development-kit:latest

shellcheck:
  image: "debian:stretch-slim"
  stage: shellcheck
  script:
    - apt-get update
    - apt-get install -y shellcheck
    # finds all executables (any executable bit is set)
    # with a shell shebang that are not in .git
    # POSIX-compliant
    - find . ! -path "./.git/*" -type f \( -perm -u=x -o -perm -g=x -o -perm -o=x \) -exec grep -l '^#!/bin/sh' {} \; | xargs shellcheck

rubocop:
  image: "ruby:2.3"
  stage: rubocop
  script:
    - gem install rubocop -v 0.49.1
    - rubocop -c gdk-rubocop.yml

build:image:
  image: docker:git
  stage: build
  script:
    # taken from https://gitlab.com/gitlab-org/gitlab-qa/blob/master/.gitlab-ci.yml
    - ./bin/docker load
    - ./bin/docker build
    - ./bin/docker store
    - test -n "$CI_BUILD_TOKEN" || exit 0
    - ./bin/docker publish
  when: manual
  cache:
      key: "docker-build-cache"
      paths:
        - ./latest_image.tar

test:install:
  image: $TEST_IMAGE
  stage: test
  artifacts:
    paths:
      - ./*.log
      - ./gitlab/log/*.log
    expire_in: 2 days
    when: always
  script:
    - source /home/gdk/.bash_profile
    - cd gem
    - gem build gitlab-development-kit.gemspec
    - gem install gitlab-development-kit-*.gem
    - cd /home/gdk
    - gdk init
    - cd gitlab-development-kit
    - git checkout $CI_COMMIT_SHA
    - netstat -lpt
    - gdk install
    - support/set-gitlab-upstream
    - killall node || true
    - gdk run &
    - sleep 30
    - curl -f --retry 10 --retry-delay 5 http://127.0.0.1:3000/
